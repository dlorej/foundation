<head>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="index.css"> 
</head>
<body>
    <div id="topbar">
        <div id ="blank"></div>
        <div id="logo">
            <img src="/icons/circle.png" alt="logo">
        </div>
        <div id="login" onclick="loginPopup()">
            Log in
        </div>
    </div>
    <div id="overlay" onclick="closeForm(false)"></div>
    <div id="popup">
        <label for="matric"><b>Matric Number</b></label>
        <input id = "matric" type="text" placeholder="Enter Matric Number" name="matric" 
            pattern="^[a-zA-Z](0[0-9]|1[0-9]|2[0-9])\d{5}[a-zA-Z]$" 
            oninput="this.value = this.value.toUpperCase()" required>

        <label for="number"><b>Phone Number</b></label>
        <input type="tel" placeholder="Enter Phone Number" name="number" required>

        <!-- <label for="psw"><b>Password</b></label>
        <input type="password" placeholder="Enter Password" name="psw" required> -->

        <button class="submit">Login</button>
    </div>

    <div class="folium-map" id="main_map" ></div>
</body>
<script>
    var main_map = L.map(
        "main_map",
        {
            center: [1.3474574403155464, 103.68459204844389],
            crs: L.CRS.EPSG3857,
            // maxBounds: [[1.3299, 103.6564], [1.3562, 103.6904]],
            zoom: 20,
            zoomControl: true,
            preferCanvas: false,
        }
    );
    var tile_layer = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {"attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors", "detectRetina": false, "maxNativeZoom": 19, "maxZoom": 19, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
    );
    
    tile_layer.addTo(main_map);
    
    async function upload(){
        fetch('./data/buildingsv3.json').then(response => response.json()).then(
            data =>{for (let key in data["features"]){
                var poly = data["features"][`${key}`]['geometry']['coordinates']
                var name = data["features"][`${key}`]["properties"]["name"]
                
                sendFn(JSON.stringify(poly),name)
            }}
        )
    }

    // upload()
    async function sendFn(encoded_polygon,name){
        var data = {
                        "name":name,
                        "poly":encoded_polygon
                    }
        

        const result = await fetch(`/api/upload`,
        {
            headers: { Accept: "*/*", "Content-Type": "application/json", },
            method:"POST",
            body: JSON.stringify(data)
        })
        const res = await result.json()
        console.log(res["message"])
    }

    async function getPolys(){
        const result = await fetch(
            `/api/getAllPolys`
        )
        const res = await result.json()
        for (let i = 0; i < res["message"].length; i++){
            var poly = JSON.parse(res["message"][i].boundary)
            var state = res["message"][i].state
            var name = res["message"][i].name
            var featureObj = {"type":"Feature",
                "geometry":
                    {"type":"MultiPolygon","coordinates":poly},
                "properties":
                    {"state":state,"name":name}
            }
            L.geoJSON(featureObj,{onEachFeature:blank,style:diff,filter:filter}).addTo(main_map)
        }
    }

    function blank(feature){
        
    }

    async function deleteBuilding(feature,layer){
        layer.on('click',async function(e){
            const temp = e.target.feature
            const success = await changeStateFn(temp.properties.name,JSON.stringify(temp.geometry.coordinates))
            if (success){
                const temp2 = temp.properties.state
                if (temp2 == 0){
                    e.target.feature.properties.state = -1
                } else if (temp2 == -1){
                    e.target.feature.properties.state = 0
                }
            }
            e.target.setStyle(diff(e.target.feature))
        })
    }

    async function changeStateFn(name,poly){
        var data = {
                        "name":name,
                        "poly":poly
                    }
        
        const result = await fetch(`/api/changeState`,
        {
            headers: { Accept: "*/*", "Content-Type": "application/json", },
            method:"POST",
            body: JSON.stringify(data)
        })
        const res = await result.json()
        if (res["message"] == "success"){
            return true
        } else {
            return false
        }
    }

    function diff(feature){
        switch (feature.properties.state) {
            case 0: return {color: "#3388FF"}; //blue
            case -1:   return {color: "red"};
        }
    }

    function filter(feature){
        if (feature.properties.state == -1) {
            return false
        } else{
            return true
        }
    }

    function loginPopup(){
        document.getElementById("popup").style.top = "20%"
        document.getElementById("overlay").style.display = "block"
    }

    function closeForm(submit){
        if (submit){

        }else{
            document.getElementById("popup").style.top = "-200%"
            document.getElementById("overlay").style.display = "none"
        }
    }
    getPolys()
</script>