<head>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>

    <style>
        #main_map {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }
        .leaflet-container { font-size: 1rem; }
        .leaflet-control-attribution {
                    display: none !important;
                }
    </style>
</head>
<body>
    <!-- <button onclick="sendFn()">press to send</button>
    <div id = "testdiv"></div> -->
    <div class="folium-map" id="main_map" ></div>
</body>
<script>

    const entities = []

    var main_map = L.map(
        "main_map",
        {
            center: [1.3474574403155464, 103.68459204844389],
            crs: L.CRS.EPSG3857,
            maxBounds: [[1.3399, 103.6764], [1.3562, 103.6904]],
            zoom: 20,
            zoomControl: true,
            preferCanvas: false,
        }
    );
    var tile_layer = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {"attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors", "detectRetina": false, "maxNativeZoom": 19, "maxZoom": 19, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
    );
    
    tile_layer.addTo(main_map);

    // fetch('./data/multipolygons.geojson').then(response => response.json())
    //     .then(data=>{console.log(data)})

    // fetch('./data/multipolygons.geojson').then(response => response.json())
    //     .then(data => {L.geoJSON(data,
    //         {onEachFeature: function (feature, layer) {
    //                 layer.on('click', function () {
    //                 this.setStyle({ color: 'green', weight: 2 });
    //                 });
    //             }
    //         }).addTo(main_map)})
    
    async function upload(){
        fetch('./data/buildingsv3.json').then(response => response.json()).then(
            data =>{for (let key in data["features"]){
                var poly = data["features"][`${key}`]['geometry']['coordinates']
                var name = data["features"][`${key}`]["properties"]["name"]
                
                sendFn(JSON.stringify(poly),name)
            }}
        )
    }

    // upload()
    async function sendFn(encoded_polygon,name){
        var data = {
                        // abc:"hello"
                        "name":name,
                        "poly":encoded_polygon
                    }
        

        const result = await fetch(`/api/upload`,
        {
            headers: { Accept: "*/*", "Content-Type": "application/json", },
            method:"POST",
            body: JSON.stringify(data)
        })
        const res = await result.json()
        console.log(res["message"])
    }

    async function getPolys(){
        const result = await fetch(
            `/api/getAllPolys`
        )
        const res = await result.json()
        for (let i = 0; i < res["message"].length; i++){
            var poly = JSON.parse(res["message"][i].boundary)
            var state = res["message"][i].state
            var name = res["message"][i].name
            var featureObj = {"type":"Feature",
                "geometry":
                    {"type":"MultiPolygon","coordinates":poly},
                "properties":
                    {"state":state,"name":name}
            }
            L.geoJSON(featureObj,{onEachFeature:displayName}).addTo(main_map)
            console.log(i)
        }
    }

    function displayName(feature,layer){
        layer.on('mouseover', function (e) {
            e.target.setStyle({color:"green"})
        })
        layer.on('mouseout',function(e){
            e.target.setStyle({color:"#3388FF"})
        })
    }

    getPolys()
</script>