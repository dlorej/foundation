<head>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>

    <style>
        #main_map {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }
        .leaflet-container { font-size: 1rem; }
        .leaflet-control-attribution {
                    display: none !important;
                }
    </style>
</head>
<body>
    <!-- <button onclick="sendFn()">press to send</button>
    <div id = "testdiv"></div> -->
    <div class="folium-map" id="main_map" ></div>
</body>
<script>
    var main_map = L.map(
        "main_map",
        {
            center: [1.3474574403155464, 103.68459204844389],
            crs: L.CRS.EPSG3857,
            maxBounds: [[1.3399, 103.6764], [1.3562, 103.6904]],
            zoom: 20,
            zoomControl: true,
            preferCanvas: false,
        }
    );
    var tile_layer = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {"attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors", "detectRetina": false, "maxNativeZoom": 19, "maxZoom": 19, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
    );
    
    tile_layer.addTo(main_map);

    fetch('./data/multipolygons.geojson').then(response => response.json())
        .then(data => {L.geoJSON(data,
            {onEachFeature: function (feature, layer) {
                    layer.on('click', function () {
                    this.setStyle({ color: 'green', weight: 2 });
                    });
                }
            }).addTo(main_map)})
    

    fetch('./data/buildingsv3.json').then(response => response.json()).then(
        data =>{for (let key in data["features"]){
            // console.log(data["features"][`${key}`])
            var poly = data["features"][`${key}`]['geometry']['coordinates'][0]
            var name = data["features"][`${key}`]["properties"]["name"]

            for (let index = 0;index < poly.length; index ++){
                var tup = poly[index].map(pair=>
                    "\(" + pair + "\)"
                )
                var encoded_polygon = encodeURIComponent(tup)
                sendFn(encoded_polygon,name)
            }
            
            // var encoded_polygon = encodeURIComponent(`(${poly.map(pair => `(${pair.join(',')})`).join(',')})`)
            
            // console.log(encoded_polygon)
            // sendFn(encoded_polygon,name)
            //chnage table in vercel add owner,storage
            //onclick = delete from table
            //upload into table for each poly



        }}
    )    

    async function sendFn(encoded_polygon,name){
        // console.log(encoded_polygon,name)
        const result = await fetch(
            `/api/upload?encoded_poly=${encoded_polygon}&name=${name}`,
            {headers: { Accept: "*/*" }, method:"POST"}
        )
        const res = await result.json()
        console.log(res["message"])
    }


//     async function sendFn(encoded_polygon,name){
//         // const result = await fetch(
//         //     `/api/upload?encoded_poly=${encoded_polygon}&name=${name}`,
//         //     {headers: { Accept: "*/*" }, method:"POST"}
//         // )
//         const result = await fetch(`/api/upload?encoded_poly=${encoded_polygon}&name=${name}`,
//             {headers: { Accept: "*/*" }, method:"POST"}
//         )
//         const res = await result.json()
//         console.log(res["message"])
//         // const poly = encodeURIComponent('((1,1),(2,3),(4,3),(6,9))')
//         // const state = 2
//         // const result = await fetch(
//         //     `/api/upload?poly=${poly}&state=${state}`,
//         //     {headers: { Accept: "*/*" }, method:"POST"})
//         // const content2 = await result.json()
//         // document.getElementById("testdiv").innerHTML = content2["message"]
//     }
    
</script>